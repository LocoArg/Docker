FROM ubuntu:16.04

MAINTAINER Emiliano Chaves <chaves.emiliano@gmail.com>
#Esta representa emi/rpy2:v5

RUN \
  apt-get update -qq && \
  apt-get install -y \
                     ed \
                     git \
		     mercurial \
		     libcairo-dev \
		     libedit-dev \
         lsb-release \
		     r-base \
		     r-base-dev \
		     wget &&\
  rm -rf /var/lib/apt/lists/*

RUN \
  apt-get update && apt-get install -y \
     python3 \
     python3-dev \
     python3-pip

RUN \
  apt-get update -qq && \
  apt-get install -y --no-install-recommends\
  libgdal-dev \
  libproj-dev  \
  mc \
  nano &&\
rm -rf /var/lib/apt/list/*

RUN \
  echo "broom\n\
        dplyr\n\
        hexbin\n\
        ggplot2\n\
        lme4\n\
        rgdal\n\
        ggmap\n\
        devtools\n\
        tidyr" > rpacks.txt && \
  R -e 'install.packages(sub("(.+)\\\\n","\\1", scan("rpacks.txt", "character")), repos="http://cran.cnr.Berkeley.edu")' && \
  rm rpacks.txt


  ENV SHELL /bin/bash
  ENV NB_USER emiliano
  ENV NB_UID 1000
  ENV PATH /opt/conda/bin:$PATH

  # Create user
  RUN useradd -m -s /bin/bash -N -u $NB_UID $NB_USER

RUN echo 'export PATH=/opt/conda/bin:$PATH' > /etc/profile.d/conda.sh
RUN \
wget --quiet https://repo.continuum.io/miniconda/Miniconda3-4.1.11-Linux-x86_64.sh -O /home/emiliano/miniconda.sh

RUN /bin/bash /home/emiliano/miniconda.sh -b -p /opt/conda

RUN conda install -y jupyter


# Setup  home directory and notebook config
USER $NB_USER
RUN mkdir /home/$NB_USER/work && \
mkdir /home/$NB_USER/.jupyter && \
mkdir /home/$NB_USER/.local && \
echo "cacert=/etc/ssl/certs/ca-certificates.crt" > /home/$NB_USER/.curlrc && \
echo "c.NotebookApp.ip = '*'" >> /home/$NB_USER/.jupyter/jupyter_notebook_config.py

USER root
RUN \
  conda install -y numpy cycler

RUN conda update -y python conda && \
conda install -y --no-deps \
notebook \
pandas \
matplotlib \
numpy \
ipywidgets \
scipy \
bokeh \
scikit-learn \
statsmodels \
python-dateutil \
scikit-image \
pyparsing \
pytz \
freetype \
libpng \
pyparsing \

&& conda clean -tipsy
RUN \
pip install https://github.com/ipython-contrib/jupyter_contrib_nbextensions/tarball/master

USER $NB_USER
RUN jupyter contrib nbextension install --user
USER root
RUN conda install -c anaconda-nb-extensions nb_conda_kernels



# Run dev version of rpy2
RUN \
  /opt/conda/bin/pip --no-cache-dir install \
       https://bitbucket.org/rpy2/rpy2/get/version_2.8.x.tar.gz && \
  rm -rf /root/.cache

USER root

RUN R -e "devtools::install_github('IRkernel/IRkernel')"

RUN R -e "IRkernel::installspec(user=FALSE)"

WORKDIR /home/$NB_USER/work

 RUN \
 json='{ "NotebookApp": {"kernel_spec_manager_class": "nb_conda_kernels.CondaKernelSpecManager"}}' && \
 cp /opt/conda/etc/jupyter/jupyter_notebook_config.json /opt/conda/etc/jupyter/jupyter_notebook_config.bak && \
 echo $json > /opt/conda/etc/jupyter/jupyter_notebook_config.json

 RUN \
 json2='{ "NotebookApp": { "nbserver_extensions": { "jupyter_nbextensions_configurator": true, "nbpresent":true, "nb_conda":true, "nb_anacondacloud":true }, "kernel_spec_manager_class":"nb_conda_kernels.CondaKernelSpecManager" } }' && \
 cp /home/emiliano/.jupyter/jupyter_notebook_config.json /home/emiliano/.jupyter/jupyter_notebook_config.bak && \
 echo $json2 > /home/emiliano/.jupyter/jupyter_notebook_config.json

 EXPOSE 8888
#RUN \
 #conda uninstall numpy

#RUN \
# conda install -y numpy

RUN \
 pip install pivottablejs
 
RUN \
 conda install -c damianavila82 rise
USER $NB_USER
#CMD /bin/bash
CMD jupyter notebook --no-browser
